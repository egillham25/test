"use strict";(self.webpackChunk_grammarly_denali_app=self.webpackChunk_grammarly_denali_app||[]).push([[7861],{71937:(e,n,t)=>{t.d(n,{DG:()=>r,V$:()=>h,sV:()=>s});var r,s,i=t(83531),a=t(19147),o=t(6922),u=t(23988),c=t(1059),d=t(87172),_=t(17843),l=t(52138);!function(e){e[e.DISCONNECTED=0]="DISCONNECTED",e[e.IDLE=1]="IDLE",e[e.CONNECTING=2]="CONNECTING",e[e.INITIALIZING=3]="INITIALIZING",e[e.CONNECTED=4]="CONNECTED",e[e.READY=5]="READY",e[e.WAIT_ACK=6]="WAIT_ACK",e[e.CLOSED=7]="CLOSED"}(r||(r={})),function(e){e[e.CONNECT=0]="CONNECT",e[e.CONNECTED=1]="CONNECTED",e[e.SCHEDULE_RECONNECT=2]="SCHEDULE_RECONNECT",e[e.DISCONNECT=3]="DISCONNECT",e[e.IDLE_DISCONNECT=4]="IDLE_DISCONNECT",e[e.CLOSE=5]="CLOSE",e[e.INITIALIZE=6]="INITIALIZE",e[e.INITIALIZED=7]="INITIALIZED",e[e.SEND=8]="SEND",e[e.ACK=9]="ACK",e[e.RESET=10]="RESET"}(s||(s={}));var h=function(){function e(n,t){var i=this;(0,a._)(this,e),(0,u._)(this,"_originalUrl",void 0),(0,u._)(this,"_log",void 0),(0,u._)(this,"_fsm",void 0),(0,u._)(this,"_conn",void 0),(0,u._)(this,"_timeout",void 0),(0,u._)(this,"_error",void 0),(0,u._)(this,"_msgCount",void 0),(0,u._)(this,"_initHandler",void 0),(0,u._)(this,"_initFailHandler",void 0),this._originalUrl=n,this._log=d.Bx.Logging.getLogger("coreclients.remote",d.y7.$.DEBUG),this._msgCount=0,t.onConnecting((function(){return i._handleConnecting()})).onConnect((function(e){return i._handleConnect(e)})).onDisconnect((function(e){return i._msgCount=0,i._handleDisconnect(e)})).onMessage((function(e,n){i._msgCount++,i._handleMessage(n)})),this._fsm=new _.Z3("remote",r.DISCONNECTED,r.CLOSED).from(r.DISCONNECTED,r.IDLE).to(r.CONNECTING).on(s.CONNECT).from(r.CONNECTING).to(r.CONNECTED).on(s.CONNECTED).from(r.CONNECTED).to(r.INITIALIZING).on(s.INITIALIZE).from(r.INITIALIZING).to(r.READY).on(s.INITIALIZED).from(r.CONNECTED,r.CONNECTING,r.INITIALIZING,r.READY).to(r.DISCONNECTED).on(s.DISCONNECT).from(r.CONNECTED,r.CONNECTING,r.INITIALIZING,r.READY,r.DISCONNECTED).to(r.CLOSED).on(s.CLOSE),this._log.isEnabled(d.y7.$.TRACE)&&this._fsm.verbose(r,s)}return(0,o._)(e,[{key:"getWsUrl",value:function(){return this._originalUrl}},{key:"init",value:function(e,n){this._log.debug("init"),this._initHandler=e,this._initFailHandler=n}},{key:"close",value:function(e,n){var t=this;return this._log.debug("close(".concat(r[this._fsm.current],")"),{code:e,reason:n}),this._fsm.event(s.CLOSE,{code:e,reason:n}).then((function(e){e&&clearTimeout(t._timeout)}))}},{key:"isClosed",value:function(){return this._fsm.is(r.CLOSED)}},{key:"_handleConnecting",value:function(){var e=this;return(0,i._)((function(){return(0,c.YH)(this,(function(n){switch(n.label){case 0:return e._log.debug("Connecting"),[4,e._fsm.event(s.CONNECT)];case 1:return n.sent()||e._log.error("Can not enter CONNECTING state",{fsmState:r[e._fsm.current]}),[2]}}))}))()}},{key:"_handleConnect",value:function(e){var n=this;return(0,i._)((function(){return(0,c.YH)(this,(function(t){switch(t.label){case 0:return n._log.debug("Connected"),[4,n._fsm.event(s.CONNECTED,e)];case 1:return t.sent()?(n._conn=e,[3,4]):[3,2];case 2:return n._log.error("Can not enter CONNECTED state",{fsmState:r[n._fsm.current]}),[4,e.close({reason:"Can not enter CONNECTED state",code:l.C.WsCodes.NORMAL_CLOSURE})];case 3:t.sent(),t.label=4;case 4:return[2]}}))}))()}},{key:"_handleDisconnect",value:function(e){var n=this;return(0,i._)((function(){var t;return(0,c.YH)(this,(function(i){switch(i.label){case 0:return n._log.debug("Disconnected",e.reason),n._disconnectHandler(e),t=n.isClosed()?d.y7.$.WARN:d.y7.$.ERROR,[4,n._fsm.event(s.DISCONNECT,e)];case 1:return i.sent()||n._log.log(t,"Can not enter DISCONNECTED state",{reason:e,fsmState:r[n._fsm.current]}),[2]}}))}))()}},{key:"_canSend",value:function(){return!this._fsm.is(r.DISCONNECTED,r.CONNECTING,r.CLOSED)}}]),e}()},92422:(e,n,t)=>{t.d(n,{b:()=>q,N:()=>V});var r,s=t(39695),i=t(83531),a=t(19147),o=t(6922),u=t(23988),c=t(29573),d=t(10334),_=t(17171),l=t(32557),h=t(1059),g=t(66202),f=t(65390),v=t(46238),p=t(84647),m=t(23916),C=t(87172),E=t(72896),I=t(94855),y=t(1395),D=t(43036),N=t(9896),S=t(85793),T=t(33060),k=t(88105),O=t(64674),b=t(49004),w=t(52138),R=t(91242),A=t(39041),M=t(36465);!function(e){var n=function e(n){(0,a._)(this,e),(0,u._)(this,"id",void 0),(0,u._)(this,"action",void 0),this.id=n};e.Base=n;var t=function(e){(0,c._)(t,e);var n=(0,l._)(t);function t(e,r,i,o,c,d){var _;return(0,a._)(this,t),_=n.call(this,e),(0,u._)((0,s._)(_),"id",void 0),(0,u._)((0,s._)(_),"cl",void 0),(0,u._)((0,s._)(_),"rev",void 0),(0,u._)((0,s._)(_),"doc_len",void 0),(0,u._)((0,s._)(_),"deltas",void 0),(0,u._)((0,s._)(_),"revAfterApply",void 0),(0,u._)((0,s._)(_),"op",void 0),_.id=e,_.cl=r,_.rev=i,_.doc_len=o,_.deltas=c,_.revAfterApply=d,_.op="patch",_}return t}(n);e.PatchMessage=t;var r=function(e){(0,c._)(t,e);var n=(0,l._)(t);function t(e,r){var i;return(0,a._)(this,t),i=n.call(this,e),(0,u._)((0,s._)(i),"id",void 0),(0,u._)((0,s._)(i),"vsn",void 0),(0,u._)((0,s._)(i),"op",void 0),i.id=e,i.vsn=r,i.op="vsn",i}return t}(n);e.VersionMessage=r;var i=function(e){(0,c._)(t,e);var n=(0,l._)(t);function t(e,r,i,o){var c;return(0,a._)(this,t),c=n.call(this,e),(0,u._)((0,s._)(c),"id",void 0),(0,u._)((0,s._)(c),"title",void 0),(0,u._)((0,s._)(c),"errors",void 0),(0,u._)((0,s._)(c),"extra_params",void 0),(0,u._)((0,s._)(c),"op",void 0),c.id=e,c.title=r,c.errors=i,c.extra_params=o,c.op="update_document_metadata",c}return t}(n);e.UpdateDocumentMetadata=i;var o=function(e){(0,c._)(t,e);var n=(0,l._)(t);function t(e){var r;return(0,a._)(this,t),r=n.call(this,e),(0,u._)((0,s._)(r),"id",void 0),(0,u._)((0,s._)(r),"op",void 0),r.id=e,r.op="proofit_turnaround_options",r}return t}(n);e.ProofitOptionsMessage=o;var d=function(e){(0,c._)(t,e);var n=(0,l._)(t);function t(e,r,i,o,c){var d,_=arguments.length>5&&void 0!==arguments[5]&&arguments[5];return(0,a._)(this,t),d=n.call(this,e),(0,u._)((0,s._)(d),"id",void 0),(0,u._)((0,s._)(d),"turnaround",void 0),(0,u._)((0,s._)(d),"clarity",void 0),(0,u._)((0,s._)(d),"userInputs",void 0),(0,u._)((0,s._)(d),"priceOfferId",void 0),(0,u._)((0,s._)(d),"payWithCredits",void 0),(0,u._)((0,s._)(d),"op",void 0),d.id=e,d.turnaround=r,d.clarity=i,d.userInputs=o,d.priceOfferId=c,d.payWithCredits=_,d.op="proofit_create_job",d}return t}(n);e.ProofitPlaceOrderMessage=d;var _=function(e){(0,c._)(t,e);var n=(0,l._)(t);function t(e,r,i,o,c){var d,_=arguments.length>5&&void 0!==arguments[5]&&arguments[5],l=arguments.length>6?arguments[6]:void 0,h=arguments.length>7?arguments[7]:void 0;return(0,a._)(this,t),d=n.call(this,e),(0,u._)((0,s._)(d),"id",void 0),(0,u._)((0,s._)(d),"turnaround",void 0),(0,u._)((0,s._)(d),"clarity",void 0),(0,u._)((0,s._)(d),"userInputs",void 0),(0,u._)((0,s._)(d),"priceOfferId",void 0),(0,u._)((0,s._)(d),"payWithCredits",void 0),(0,u._)((0,s._)(d),"nonce",void 0),(0,u._)((0,s._)(d),"billingZip",void 0),(0,u._)((0,s._)(d),"op",void 0),d.id=e,d.turnaround=r,d.clarity=i,d.userInputs=o,d.priceOfferId=c,d.payWithCredits=_,d.nonce=l,d.billingZip=h,d.op="proofit_create_job",d}return t}(n);e.ProofitPlacePaymentOrderMessage=_;var h=function(e){(0,c._)(t,e);var n=(0,l._)(t);function t(e){var r;return(0,a._)(this,t),r=n.call(this,e),(0,u._)((0,s._)(r),"id",void 0),(0,u._)((0,s._)(r),"op",void 0),r.id=e,r.op="proofit_statistics",r}return t}(n);e.ProofitStatisticsMessage=h;var g=function(e){(0,c._)(t,e);var n=(0,l._)(t);function t(e,r){var i;return(0,a._)(this,t),i=n.call(this,e),(0,u._)((0,s._)(i),"id",void 0),(0,u._)((0,s._)(i),"token",void 0),(0,u._)((0,s._)(i),"op",void 0),i.id=e,i.token=r,i.op="token_response",i}return t}(n);e.TokenResponse=g}(r||(r={}));var H,P=t(91817),L=t(56610);!function(e){e.isChange=function(e){return"change"===e.kind},e.isCmd=function(e){return"cmd"===e.kind},e.isMeta=function(e){return"meta"===e.kind}}(H||(H={}));var q,G=function(){function e(n,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];(0,a._)(this,e),(0,u._)(this,"_acceptHandler",void 0),(0,u._)(this,"_dropHandler",void 0),(0,u._)(this,"_changes",void 0),(0,u._)(this,"_staging",void 0),(0,u._)(this,"_queuedId",void 0),this._acceptHandler=n,this._dropHandler=t,this._changes=r,this._staging=!1,this._queuedId=0}return(0,o._)(e,[{key:"pushChanges",value:function(e){var n=this,t=this.isEmpty||this._staging&&1===this._changes.length?f.none:(0,p.pipe)(this._tail(),f.filter(H.isChange));return(0,p.pipe)(t,f.fold((function(){return n._enqueueChanges(b.zV.split(e,5e3))}),(function(t){var r=t.change.compose(e),s=(0,L._)(b.zV.split(r,5e3)),i=s[0],a=s.slice(1);if(n._replaceChange(n._changes.length-1,i),i.isEmpty){var o=n._changes.pop();setTimeout((function(){return n._acceptHandler(o)}),0)}return[t.id].concat(n._enqueueChanges(a))})))}},{key:"pushMeta",value:function(e){var n=this,t=this.isEmpty||this._staging&&1===this._changes.length?f.none:(0,p.pipe)(this._tail(),f.filter(H.isMeta));return(0,p.pipe)(t,f.fold((function(){var t=n._queuedId++;return n._changes.push({kind:"meta",meta:e,id:t}),t}),(function(n){return Object.assign(n.meta,e),n.id})))}},{key:"pushCommand",value:function(e){var n=this._queuedId++;return this._changes.push({kind:"cmd",cmd:e,id:n}),n}},{key:"isStaging",get:function(){return this._staging}},{key:"isEmpty",get:function(){return 0===this._changes.length}},{key:"size",get:function(){return this._changes.length}},{key:"poll",value:function(){var e=this;(0,y.V1)(!this._staging,"Should not be in staging mode");var n=f.fromNullable(this._changes[0]);return(0,p.pipe)(n,f.fold(p.constVoid,(function(){return e._staging=!0}))),n}},{key:"pop",value:function(){(0,y.V1)(!this._staging,"Should not be in staging mode");var e=f.fromNullable(this._changes.shift());return(0,p.pipe)(e,f.fold(p.constVoid,this._acceptHandler)),e}},{key:"unstage",value:function(){(0,y.V1)(this._staging,"Should be in staging mode"),(0,y.V1)(void 0!==this._changes[0],"Staging change should exist"),this._staging=!1}},{key:"ack",value:function(){this.unstage(),this.pop()}},{key:"transformChangeAgainstQueue",value:function(e){var n=this;return this._changes.reduce((function(e,t,r){if(H.isChange(t)){var s=t.change,i=s.transform(e,!1);return n._replaceChange(r,i),e.transform(s)}return e}),e)}},{key:"drop",value:function(e,n){if(!this.isEmpty){var t=(0,P._)(void 0===n?[this._changes,[]]:N.jB(this._changes,(function(e){return e.kind===n})),2),r=t[0],s=t[1];this._changes=s,r.length>0&&this._dropHandler({messages:r,reason:e})}}},{key:"toJSON",value:function(){return{changes:this._changes}}},{key:"_tail",value:function(){return f.fromNullable(this._changes[this._changes.length-1])}},{key:"_enqueueChanges",value:function(e){var n=this;return e.map((function(e){var t=n._queuedId++;return n._changes.push({kind:"change",change:e,id:t}),t}))}},{key:"_replaceChange",value:function(e,n){var t=this._changes[e];(0,y.V1)(H.isChange(t),"queued change should exist"),t.change=n}}]),e}(),x=t(71937),Q=t(32062),V=function(e){(0,c._)(t,e);var n=(0,l._)(t);function t(e,i,o){var c,d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:q.Queue.create({}),_=arguments.length>4&&void 0!==arguments[4]?arguments[4]:500,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:15e3;return(0,a._)(this,t),c=n.call(this,e,i),(0,u._)((0,s._)(c),"_changesQueue",void 0),(0,u._)((0,s._)(c),"_sendDelay",void 0),(0,u._)((0,s._)(c),"_requestTimeout",void 0),(0,u._)((0,s._)(c),"_nextId",void 0),(0,u._)((0,s._)(c),"_revision",void 0),(0,u._)((0,s._)(c),"_clientId",void 0),(0,u._)((0,s._)(c),"_forceSend",void 0),(0,u._)((0,s._)(c),"_handler",void 0),(0,u._)((0,s._)(c),"_proofitPlansRequester",void 0),(0,u._)((0,s._)(c),"_proofitStatisticsRequester",void 0),(0,u._)((0,s._)(c),"_proofitCreateJobRequester",void 0),(0,u._)((0,s._)(c),"getProofitPlans",void 0),(0,u._)((0,s._)(c),"getProofitStatistics",void 0),(0,u._)((0,s._)(c),"_disconnectHandler",void 0),(0,u._)((0,s._)(c),"_resolvePendingFlushPromise",void 0),(0,u._)((0,s._)(c),"_flushPromise",void 0),c._changesQueue=d,c._sendDelay=_,c._requestTimeout=l,c._nextId=1,c._revision=-1,c._clientId=-1,c._forceSend=!1,c._proofitPlansRequester=new R.Wo(c._requestTimeout,"DOX.ProofitPlans"),c._proofitStatisticsRequester=new R.Wo(c._requestTimeout,"DOX.ProofitStatistics"),c._proofitCreateJobRequester=new R.Wo(c._requestTimeout,"DOX.ProofitCreateJob"),c.getProofitPlans=c._startRequestWatch(c._proofitPlansRequester,c._sendInbandCommand((function(e){return new r.ProofitOptionsMessage(e)}))),c.getProofitStatistics=c._startRequestWatch(c._proofitStatisticsRequester,c._sendInbandCommand((function(e){return new r.ProofitStatisticsMessage(e)}))),c._disconnectHandler=function(){c._changesQueue.isStaging&&(c._log.warn("Got disconnect while trying send changes"),c._changesQueue.unstage()),[c._proofitCreateJobRequester,c._proofitPlansRequester,c._proofitStatisticsRequester].forEach((function(e){return e.clear("disconnect")}))},c._resolvePendingFlushPromise=function(e){return(0,p.constVoid)()},c._handler=new q.DefaultHandler(o),c._fsm.from(x.DG.READY).to(x.DG.WAIT_ACK).on(x.sV.SEND).from(x.DG.WAIT_ACK).to(x.DG.READY).on(x.sV.ACK,x.sV.RESET).from(x.DG.WAIT_ACK).to(x.DG.DISCONNECTED).on(x.sV.DISCONNECT).from(x.DG.WAIT_ACK).to(x.DG.CLOSED).on(x.sV.CLOSE).on(x.DG.READY,(function(e){return c._trySendAfterTimeout()})).on(x.DG.CLOSED,(function(e){var n=Boolean(e.args)?e.args:null,t=n?new A.v0({code:n.code,status:M.h.CLOSED_ERROR.status,message:Boolean(n.reason)?n.reason:M.h.CLOSED_ERROR.message}):M.h.CLOSED_ERROR;c._failInit(t),c._changesQueue.drop("close")})).on(x.DG.DISCONNECTED,(function(){c._changesQueue.drop("disconnect","cmd")})),(0,E.hJ)("doxReset",(function(e){if(void 0===e)throw new Error("provide text!");c._handleResetMessage({op:"reset",id:c._nextId++,doc:(new O.R).insert(e),vsn:c._revision+10,clientId:c._clientId})})),(0,E.hJ)("doxState",(0,s._)(c)),(0,E.hJ)("closeDoxSocket",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,n=arguments.length>1?arguments[1]:void 0;c._conn._ws.close(e,n)})),c}return(0,o._)(t,[{key:"_isFirstConnect",get:function(){return null!=this._initHandler}},{key:"_startRequestWatch",value:function(e,n){return(0,p.pipe)(n,I.AU((function(e){return I.kb(e)}),(function(n){return function(){return e.watchRequest(n)}})))}},{key:"isInitialRevision",get:function(){return 1===this._revision}},{key:"fsmState",get:function(){return x.DG[this._fsm.current]}},{key:"placeProofitOrder",value:function(e,n){var t=m.c.PlanType[e.turnaround],s=e.tier===m.c.PlanTier.Clarity,i={dialect:f.toUndefined(e.userInputs.dialect),quotationType:f.toUndefined(e.userInputs.quotationType),spaceType:f.toUndefined(e.userInputs.spaceType),noteToEditor:f.toUndefined(e.userInputs.noteToEditor)},a=e.priceOfferId,o=e.payWithCredits,u=(0,p.pipe)(n,f.fold((function(){return function(e){return new r.ProofitPlaceOrderMessage(e,t,s,i,a,o)}}),(function(e){if(e.kind===T.b.creditCard){var n=e;return function(e){return new r.ProofitPlacePaymentOrderMessage(e,t,s,i,a,o,n.nonce,n.postalCode)}}if(e.kind===T.b.paypal){var u=e;return function(e){return new r.ProofitPlacePaymentOrderMessage(e,t,s,i,a,o,u.nonce)}}return(0,y.xb)(e)})));return this._startRequestWatch(this._proofitCreateJobRequester,this._sendInbandCommand(u))}},{key:"pushChanges",value:function(e){var n=this;return D.uC((function(){return n._pushChanges(e)}))}},{key:"updateMetadata",value:function(e){var n=this;return D.uC((function(){return n._updateMetadata(e)}))}},{key:"getWsUrl",value:function(){if(-1===this._revision)return this._originalUrl;var e=new URL(this._originalUrl);return e.searchParams.append("sinceVersion",String(this._revision)),e.toString()}},{key:"_handleMessage",value:function(e){var n=this;return(0,i._)((function(){var t;return(0,h.YH)(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,n._messageHandler(e)];case 1:return r.sent(),[3,3];case 2:return t=r.sent(),n._log.warn("Fail on processing incoming message",t),n._failInit(t),n._conn.close({code:w.C.WsCodes.CLIENT_MALFUNCTION,reason:"Unexpected failure on: ".concat((0,y.Cb)(t)?t.message:"")}),[3,3];case 3:return[2]}}))}))()}},{key:"_messageHandler",value:function(e){var n=this;return(0,i._)((function(){return(0,h.YH)(this,(function(t){switch(t.label){case 0:switch(n._log.isEnabled(C.y7.$.TRACE)&&n._log.trace("Message <<<",{message:JSON.stringify(e)}),e.op){case"init":return[3,1];case"patch":return[3,3];case"reset":return[3,9];case"vsn":return[3,11];case"mongodb_change":return[3,12];case"document_metadata_changed":return[3,13];case"proofit_turnaround_options":return[3,14];case"proofit_create_job":return[3,15];case"proofit_statistics":return[3,16];case"token_request":return[3,17]}return[3,19];case 1:return[4,n._handleInitMessage(e)];case 2:return t.sent(),[3,20];case 3:return n._fsm.is(x.DG.READY)||n._fsm.is(x.DG.WAIT_ACK)&&n._clientId===e.cl?[4,n._handlePatchMessage(e)]:[3,5];case 4:return t.sent(),[3,8];case 5:return n._fsm.is(x.DG.WAIT_ACK)?(n._log.warn("got change while waiting ack for other change"),[4,n._handlePatchMessage(e)]):[3,7];case 6:return t.sent(),[3,8];case 7:n._log.warn("got unexpected patch message",{fsmState:x.DG[n._fsm.current]}),t.label=8;case 8:return[3,20];case 9:return[4,n._handleResetMessage(e)];case 10:return t.sent(),[3,20];case 11:case 12:return[3,20];case 13:return n._handleMetaChangeMessage(e),[3,20];case 14:return(0,p.pipe)(m.c.processOptions((0,p.unsafeCoerce)(e)),g.fold((function(t){return n._proofitPlansRequester.onError(e.id,t)}),(function(t){return n._proofitPlansRequester.onValue(e.id,t)}))),[3,20];case 15:return n._proofitCreateJobRequester.onValue(e.id,m.c.parseCreateJobResult(e)),[3,20];case 16:return n._proofitStatisticsRequester.onValue(e.id,m.c.processStatistics(e)),[3,20];case 17:return[4,n._handleUpdateTokenRequest()];case 18:return t.sent(),[3,20];case 19:e.error||(n._log.warn("Unexpected message",{message:e}),n._failInit(e)),t.label=20;case 20:return[2]}}))}))()}},{key:"_handleInitMessage",value:function(e){var n=this;return(0,i._)((function(){var t,s,i,a,o;return(0,h.YH)(this,(function(u){switch(u.label){case 0:return[4,n._fsm.event(x.sV.INITIALIZE)];case 1:return u.sent()?(t=void 0!==e.deltas?e.deltas:[]).length>0?(n._log.debug("Got changes on init. Skipping reset"),s=N.qI(t.map((function(e){return e.deltas}))),i=t[0].doc_len,a=t[0].rev,[4,n._handlePatchMessage(new r.PatchMessage(-1,-1,a,i,s,e.vsn),e.doc_len)]):[3,3]:[3,5];case 2:u.sent(),u.label=3;case 3:return o=new O.R(e.doc),n._initHandler?(n._log.trace("calling _initHandler"),n._initHandler({initialDelta:b.lY.unsafeRes(o),remoteDocument:n,meta:q.Meta.parse(e)}),n._initHandler=null,n._initFailHandler=null,n._clear(e)):0===t.length&&e.vsn!==n._revision?(n._log.debug("Remote has unknown revision, goto reset"),n._handleResetMessage({id:-1,op:"reset",clientId:e.clientId,vsn:e.vsn,doc:o})):n._clear(e),n._log.trace("Init complete, going to INITIALIZED"),[4,n._fsm.event(x.sV.INITIALIZED)];case 4:return u.sent(),[3,5];case 5:return[2]}}))}))()}},{key:"inSync",get:function(){return this._changesQueue.isEmpty&&!this._changesQueue.isStaging}},{key:"isStable",value:function(e){return void 0!==e&&void 0===e.error&&this._msgCount>5}},{key:"_handlePatchMessage",value:function(e,n){var t=this;return(0,i._)((function(){var s,i,a,o,u;return(0,h.YH)(this,(function(c){switch(c.label){case 0:return(s=e.cl===t._clientId)?(t._log.trace("got patch from same client"),[4,t._fsm.event(x.sV.ACK)]):[3,2];case 1:return c.sent()?(t._log.trace("got ack for patch"),t._changesQueue.ack()):t._log.debug("got patch message from same client, but we are in unexpected state",{state:x.DG[t._fsm.current]}),[3,3];case 2:t._log.trace("got patch from other client"),(0,R.vA)(t._revision,e.rev,"incoming patch should be on known revision"),t._handler.changeHandler(t,b.lY.flush()),i=k.E.squash(e.deltas),a=b.lY.delta(new O.R(i),e.doc_len),void 0!==n&&(0,R.vA)(n,a.length+a.prevLen,"validated doc_len should match"),t._log.isEnabled(C.y7.$.TRACE)&&!t._changesQueue.isEmpty&&t._log.trace("received incoming change, while has outgoing changes",JSON.stringify(a)),o=t._changesQueue.transformChangeAgainstQueue(a),a.prevLen!==o.prevLen&&(t._log.debug("incoming delta changed prev_len after transform on queue",{was:a.prevLen,now:o.prevLen}),t._log.trace("incoming delta transformed to",o)),t._handler.changeHandler(t,o),c.label=3;case 3:t._revision=s?e.rev:void 0===e.revAfterApply?e.rev+1:e.revAfterApply,c.label=4;case 4:return c.trys.push([4,6,,7]),[4,t._conn.send(new r.VersionMessage(t._nextId++,e.rev))];case 5:return c.sent(),[3,7];case 6:return u=c.sent(),t._log.debug("fail onsend vsn ack",u),[3,7];case 7:return[2]}}))}))()}},{key:"_handleResetMessage",value:function(e){var n=this;return(0,i._)((function(){var t;return(0,h.YH)(this,(function(r){switch(r.label){case 0:return n._log.warn("Got RESET message. currently in ".concat(x.DG[n._fsm.current])),(t=n._fsm.is(x.DG.READY))?[3,2]:[4,n._fsm.event(x.sV.RESET)];case 1:t=r.sent(),r.label=2;case 2:return t?(n._changesQueue.isStaging&&(n._log.debug("We got reset while trying send changed"),n._changesQueue.unstage()),n._changesQueue.drop("got reset"),n._clear(e),n._handler.changeHandler(n,b.lY.unsafeRes(new O.R(e.doc)))):n._log.warn("Can not enter reset state, currently in ".concat(x.DG[n._fsm.current])),[2]}}))}))()}},{key:"_handleMetaChangeMessage",value:function(e){this._changesQueue.drop("got incoming meta","meta");var n=q.Meta.parse(e);this._handler.metadataChangeHandler(this,n)}},{key:"_handleUpdateTokenRequest",value:function(){var e=this;this._log.debug("_handleUpdateTokenRequest");var n=v.of((0,p.constVoid)());return(0,p.pipe)(this._handler.updateTokenHandler,I.cy(f.fold((function(){return I.pG("Token is missing")}),(function(n){return(0,p.pipe)(e._sendInbandCommand((function(e){return new r.TokenResponse(e,n)})),I.Tj((function(){return"Token updated"})))}))),I.AU((function(t){return e._log.warn("Fail on update token request",t),n}),(function(t){return e._log.debug(t),n})))()}},{key:"_failInit",value:function(e){this._initFailHandler&&(this._log.trace("_failInit(".concat(x.DG[this._fsm.current],")")),this._initFailHandler(e),this._initHandler=null,this._initFailHandler=null)}},{key:"_clear",value:function(e){var n=e.vsn,t=e.clientId;this._log.trace("_clear: resetting client id ".concat(this._clientId," -> ").concat(t,", revision ").concat(this._revision," -> ").concat(n)),this._nextId=1,this._clientId=t,this._revision=n}},{key:"flush",value:function(){var e=this;if(this._log.trace("flush(".concat(x.DG[this._fsm.current],")")),this._changesQueue.isEmpty)return this._resolvePendingFlushPromise(),Promise.resolve();if(!this._flushPromise){var n,t=function(){e._flushPromise=void 0,e._forceSend=!1,e._resolvePendingFlushPromise=p.constVoid,n&&clearTimeout(n)};this._flushPromise=new Promise((function(t,r){e._forceSend=!0,e._resolvePendingFlushPromise=t,n=window.setTimeout((function(){return r(new R.MU("flush takes too long"))}),4e3)})).then(t,(function(e){throw t(),e})),Boolean(this._timeout)&&(clearTimeout(this._timeout),this._timeout=void 0,this._trySendAfterTimeout())}return this._flushPromise}},{key:"_trySendAfterTimeout",value:function(){var e=this;Boolean(this._timeout)||(this._timeout=window.setTimeout((function(){e._timeout=void 0,e._fsm.is(x.DG.READY)?e._changesQueue.isEmpty||e._changesQueue.isStaging?(e._changesQueue.isEmpty&&e._resolvePendingFlushPromise(),e._trySendAfterTimeout()):e._send().catch((function(n){return e._log.warn("unexpected error onsend",n)})):e._log.trace("_trySendAfterTimeout: not in READY, stopping send loop")}),this._changesQueue.size>1||this._forceSend?this._changesQueue.isStaging?250:0:this._sendDelay))}},{key:"_send",value:function(){var e=this;return(0,i._)((function(){var n;return(0,h.YH)(this,(function(t){switch(t.label){case 0:return[4,e._fsm.event(x.sV.SEND)];case 1:return t.sent()?(n=e._changesQueue.poll(),[4,(0,p.pipe)(n,f.map((r=(0,i._)((function(n){var t,r,s;return(0,h.YH)(this,(function(i){switch(i.label){case 0:t=H.isChange(n),r=e._createMessage(n),e._log.isEnabled(C.y7.$.TRACE)&&e._log.trace("Message >>>",{message:JSON.stringify(r)}),i.label=1;case 1:return i.trys.push([1,5,,6]),[4,e._conn.send(r)];case 2:return i.sent(),t?[3,4]:[4,e._fsm.event(x.sV.ACK)];case 3:i.sent()?e._changesQueue.ack():e._log.debug("can not do ack for non change msg because we are in unexpected state",{state:x.DG[e._fsm.current]}),i.label=4;case 4:return[3,6];case 5:return s=i.sent(),e._log.error("Got error on ws send: ".concat(JSON.stringify({error:s,connectionState:e._conn.state,fsmState:x.DG[e._fsm.current],queueSize:e._changesQueue.size,messageKind:n.kind},void 0,2))),[3,6];case 6:return[2]}}))})),function(e){return r.apply(this,arguments)})),f.getOrElse((function(){return Promise.resolve()})))]):[3,3];case 2:return t.sent(),[3,4];case 3:e._log.warn("we can not send"),t.label=4;case 4:return[2]}var r}))}))()}},{key:"_updateMetadata",value:function(e){return this._log.trace("_updateMetadata"),this._canSend()?g.right(this._changesQueue.pushMeta(e)):(this._log.debug("updateMetadata: cannot send, rejecting changes"),this._isFirstConnect?g.left({error:new R.Xb("Cannot send commands as WS connection is down"),queueId:f.none}):g.left({error:new R.Xb("Cannot send commands as WS connection is down"),queueId:f.some(this._changesQueue.pushMeta(e))}))}},{key:"_pushChanges",value:function(e){return this._log.trace("pushChanges: ".concat(e.kind)),b.lY.isDelta(e)?this._canSend()?g.right(this._changesQueue.pushChanges(e)):(this._log.debug("pushChanges: cannot send, rejecting changes"),this._isFirstConnect?g.left({error:new R.Xb("Cannot send commands as WS connection is down"),queueIds:f.none}):g.left({error:new R.Xb("Cannot send commands as WS connection is down"),queueIds:f.some(this._changesQueue.pushChanges(e))})):b.lY.isReset(e)?g.left({error:new Error("Invalid change. Reset changes are not supported by dox"),queueIds:f.none}):g.right([])}},{key:"_sendInbandCommand",value:function(e){var n=this;return I.oF((function(){var t=e(n._nextId++);if(n._log.trace("_sendInbandCommand:",t.op),!n._canSend())return n._log.warn("_sendInbandCommand: cannot send, rejecting command",t.op),g.left(new R.Xb("Cannot send commands as WS connection is down"));var r=n._changesQueue.isEmpty;return n._changesQueue.pushCommand(t),r&&n._fsm.is(x.DG.READY)&&(n._log.trace("Q.isEmpty, sending command immidiately",t),n._send()),g.right(t.id)}))}},{key:"_createMessage",value:function(e){switch(e.kind){case"change":return this._createPatchMessage(e.change);case"meta":return this._createUpdateMetaMessage(e.meta);case"cmd":return e.cmd;default:return(0,y.xb)(e)}}},{key:"_createPatchMessage",value:function(e){return new r.PatchMessage(this._nextId++,this._clientId,this._revision,e.prevLen,[e.delta])}},{key:"_createUpdateMetaMessage",value:function(e){var n=e.title,t=e.errors,s=e.settings;return new r.UpdateDocumentMetadata(this._nextId++,n,t,void 0!==s?s.toJSON():void 0)}}],[{key:"getWsDocumentUrl",value:function(e,n){var t=void 0===n?"/documents/ws":"/documents/".concat(n,"/ws");return"".concat(e).concat(t)}}]),t}(x.V$);!function(e){var n,t;(e.Meta||(e.Meta={})).parse=function(e){var n=e.title,t=e.errors,r=e.extra_params,s=e.proofit,i={title:n,errors:t,settings:Q.O.Holder.fromJSON(r),proofit:m.c.fromRaw(s)};return"init"===e.op?(0,_._)((0,d._)({},i),{isDemoDocument:Boolean(e.demo),createdAt:(0,p.pipe)(S.Yr.parseDate(e.created_at),g.getOrElse((function(){return null}))),originalFilename:e.orig_filename}):i},e.DefaultHandler=function e(n){(0,a._)(this,e),(0,u._)(this,"_handler",void 0),(0,u._)(this,"changeHandler",void 0),(0,u._)(this,"metadataChangeHandler",void 0),(0,u._)(this,"connectHandler",void 0),(0,u._)(this,"disconnectHandler",void 0),(0,u._)(this,"updateTokenHandler",void 0),this._handler=n,this.changeHandler=this._handler.changeHandler||p.constVoid,this.metadataChangeHandler=this._handler.metadataChangeHandler||p.constVoid,this.connectHandler=this._handler.connectHandler||p.constVoid,this.disconnectHandler=this._handler.disconnectHandler||p.constVoid,this.updateTokenHandler=this._handler.updateTokenHandler||I.pG(f.none)},n=e.Queue||(e.Queue={}),t=function e(n){(0,a._)(this,e),(0,u._)(this,"_handler",void 0),(0,u._)(this,"acceptedMsgHandler",void 0),(0,u._)(this,"droppedMsgsHandler",void 0),this._handler=n,this.acceptedMsgHandler=this._handler.acceptedMsgHandler||function(){},this.droppedMsgsHandler=this._handler.droppedMsgsHandler||function(){}},n.DefaultHandler=t,n.create=function(e){var n=new t(e),r=n.acceptedMsgHandler,s=n.droppedMsgsHandler;return new G(r,s)}}(q||(q={}))},45584:(e,n,t)=>{t.d(n,{JK:()=>s,aq:()=>r,dQ:()=>i});class r extends Error{toString(){return`${this.name}: ${this.message}${Boolean(this.reason)?` - ${String(this.reason)}`:""}`}static is(e){return e instanceof r}constructor(e,n){super(e),this.reason=void 0,this.reason=n,this.name="StorageError","captureStackTrace"in Error?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack}}function s(e){return n=>new r(e,n)}function i(e){var n;return Boolean(null==(n=function(e){const n=e.reason;return null==n?null:"string"==typeof n?n:"object"==typeof n&&"string"==typeof(null==n?void 0:n.name)?String(n.name):null}(e))?void 0:n.startsWith("QuotaExceeded"))}},36377:(e,n,t)=>{t.d(n,{Hi:()=>b,q3:()=>k,FA:()=>O});var r={};t.r(r),t.d(r,{Direction:()=>i,MaxAgeOrigin:()=>a,OrderBy:()=>o});var s={};t.r(s),t.d(s,{ClientMessage:()=>_,ClientMessageImplementations:()=>N,Direction:()=>f,Entry:()=>v,MaxAgeOrigin:()=>p,Message:()=>m,MessageClear:()=>E,MessageEntries:()=>y,MessageGet:()=>C,MessageSave:()=>I,OrderBy:()=>D,ProtocolMessage:()=>l,ProtocolMessageImplementations:()=>S,Root:()=>g,ServerMessage:()=>h,ServerMessageImplementations:()=>T,interpreter:()=>d.n});var i,a,o,u=t(95934);!function(e){e.Descending="descending",e.Ascending="ascending"}(i||(i={})),function(e){e.Write="write",e.ReadWrite="read-write"}(a||(a={})),function(e){e.CreationTime="creation-time",e.ExpirationTime="expiration-time"}(o||(o={}));var c=t(27234),d=t(38791),_=(0,d.L)((function(e){return(0,c.y$)(l(e),e.struct({}))(e)})),l=(0,d.L)((function(e){return e.struct({id:e.number})})),h=(0,d.L)((function(e){return(0,c.y$)(l(e),e.struct({}))(e)})),g=(0,d.L)((function(e){return m(e)})),f=(0,c.Ds)(i),v=(0,d.L)((function(e){return e.struct({key:e.string,data:e.string})})),p=(0,c.Ds)(a),m=(0,d.L)((function(e){var n;return e.sum("action")(((n={})["storage:get"]=C(e),n["storage:clear"]=E(e),n["storage:save"]=I(e),n["storage:entries"]=y(e),n))})),C=(0,d.L)((function(e){return(0,c.y$)(l(e),h(e),e.intersect(e.partial({maxEntries:e.number}))(e.intersect(e.partial({orderBy:D(e)}))(e.intersect(e.partial({direction:f(e)}))(e.struct({action:e.literal("storage:get"),keyPrefixes:e.readonly(e.array(e.string))})))))(e)})),E=(0,d.L)((function(e){return(0,c.y$)(l(e),h(e),e.struct({action:e.literal("storage:clear"),keyPrefixes:e.readonly(e.array(e.string))}))(e)})),I=(0,d.L)((function(e){return(0,c.y$)(l(e),h(e),e.struct({action:e.literal("storage:save"),key:e.string,data:e.string,maxAgeSeconds:e.number,maxAgeOrigin:p(e)}))(e)})),y=(0,d.L)((function(e){return(0,c.y$)(_(e),l(e),e.struct({action:e.literal("storage:entries"),data:e.readonly(e.array(v(e)))}))(e)})),D=(0,c.Ds)(o),N=(0,d.L)((function(e){var n;return e.sum("action")(((n={})["storage:entries"]=y(e),n))})),S=(0,d.L)((function(e){var n;return e.sum("action")(((n={})["storage:get"]=C(e),n["storage:clear"]=E(e),n["storage:save"]=I(e),n["storage:entries"]=y(e),n))})),T=(0,d.L)((function(e){var n;return e.sum("action")(((n={})["storage:get"]=C(e),n["storage:clear"]=E(e),n["storage:save"]=I(e),n))}));const k=r,O=s;var b,w;(w=b||(b={})).Codec=u.tB(u.NW({action:u.tB(u.eu("storage")),id:u.tB(u.ai)})),w.is=w.Codec.is},2817:(e,n,t)=>{function r(e){return new Blob([e]).size}t.d(n,{d:()=>r})}}]);